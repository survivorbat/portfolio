parameters:
  - name: terraformDockerImage
    type: string
    default: 'survivorbat/terraform-scratch:0.12.24'
  - name: rootDirectory
    type: string

steps:
  - bash: |
      docker pull ${{ parameters.terraformDockerImage }}
    displayName: Pull ${{ parameters.terraformDockerImage }}
  - bash: |
      echo "docker run -v ${{ parameters.rootDirectory }}:/app ${{ parameters.terraformDockerImage }} init"
      docker run \
        -u root \
        --rm \
        -v ${{ parameters.rootDirectory }}:/app \
        ${{ parameters.terraformDockerImage }} \
        init
    displayName: Initialize ${{ parameters.rootDirectory }}
  - bash: |
      echo "docker run -v ${{ parameters.rootDirectory }}:/app ${{ parameters.terraformDockerImage }} validate"
      docker run \
        -u root \
        --rm \
        -v ${{ parameters.rootDirectory }}:/app \
        ${{ parameters.terraformDockerImage }} \
        validate
    displayName: Validate ${{ parameters.rootDirectory }}
  - bash: |
      echo "docker run -v ${{ parameters.rootDirectory }}:/app ${{ parameters.terraformDockerImage }} apply"
      docker run \
        -u root \
        --rm \
        -v ${{ parameters.rootDirectory }}:/app \
        ${{ parameters.terraformDockerImage }} \
        apply \
        -auto-approve
    displayName: Apply ${{ parameters.rootDirectory }}
