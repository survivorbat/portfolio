parameters:
  - name: ansibleDockerImage
    type: string
    default: 'survivorbat/ansible:v0.4'
  - name: rootDirectory
    type: string
  - name: playbookFileName
    type: string
    default: site.yaml
  - name: requirementsFileName
    type: string
    default: requirements.yaml
  - name: ansibleEnvironment
    type: object
    default: {}
  - name: inventoryFileName
    type: string

steps:
  - bash: |
      docker pull ${{ parameters.ansibleDockerImage }}
    displayName: Pull ${{ parameters.ansibleDockerImage }}

  - bash: |
      docker run --rm -v ${{ parameters.rootDirectory }}:/app ${{ parameters.ansibleDockerImage }} ansible-galaxy install -r /app/${{ parameters.requirementsFileName }}
    displayName: Run ansible-galaxy install

  - bash: |
      docker run --rm -v ${{ parameters.rootDirectory }}:/app ${{ parameters.ansibleDockerImage }} ansible-playbook -i /app/${{ inventoryFileName }} /app/${{ parameters.playbookFileName }}
    env: ${{ parameters.ansibleEnvironment }}
    displayName: Run ansible
