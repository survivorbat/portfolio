parameters:
  - name: ansibleDockerImage
    type: string
    default: 'survivorbat/ansible:v0.4'
  - name: rootDirectory
    type: string
  - name: playbookFileName
    type: string
    default: site.yaml
  - name: requirementsFileName
    type: string
    default: requirements.yaml
  - name: ansibleEnvironment
    type: object
    default: {}
  - name: inventoryFileName
    type: string
  - name: privateKeyName
    type: string

steps:
  - task: DownloadSecureFile@1
    name: privateKey
    inputs:
      secureFile: ${{ parameters.privateKeyName }}
    displayName: ${{ parameters.privateKeyName }}

  - bash: |
      docker pull ${{ parameters.ansibleDockerImage }}
    displayName: Pull ${{ parameters.ansibleDockerImage }}

  - bash: |
      docker run \
        --rm \
        -v $(privateKey.secureFilePath):/root/.ssh/id_rsa \
        -v ${{ parameters.rootDirectory }}:/app \
        ${{ parameters.ansibleDockerImage }} \
        /bin/sh -c "\
          eval (ssh-agent) && \
          ssh-add /root/.ssh/id_rsa && \
          ansible-galaxy install -r /app/${{ parameters.requirementsFileName }} && \
          ansible-playbook -u root -i /app/${{ parameters.inventoryFileName }} /app/${{ parameters.playbookFileName }} --private-key /root/.ssh/id_rsa \
        "
    env:
      ANSIBLE_HOST_KEY_CHECKING: false
    displayName: Running ${{ parameters.playbookFileName }} with key ${{ parameters.privateKeyName }} and inventory ${{ parameters.inventoryFileName }}
