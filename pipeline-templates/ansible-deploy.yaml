parameters:
  - name: rootDirectory
    type: string
  - name: playbookFileName
    type: string
    default: site.yaml
  - name: requirementsFileName
    type: string
    default: requirements.yaml
  - name: ansibleEnvironment
    type: object
    default: {}
  - name: inventoryFileName
    type: string
  - name: privateKeyName
    type: string

steps:
  - task: DownloadSecureFile@1
    name: privateKey
    inputs:
      secureFile: ${{ parameters.privateKeyName }}
    displayName: ${{ parameters.privateKeyName }}

  - bash: |
      pip install ansible
    displayName: Install Ansible

  - bash: |
      export ANSIBLE_HOST_KEY_CHECKING: false
      chmod 600 $(privateKey.secureFilePath)
      ansible-galaxy install -r ${{ parameters.requirementsFileName }}
      ansible-playbook -u root -i ${{ parameters.inventoryFileName }} ${{ parameters.playbookFileName }} --private-key $(privateKey.secureFilePath)
    env: ${{ parameters.ansibleEnvironment }}
    workingDirectory: ${{ parameters.rootDirectory }}
    displayName: Running ${{ parameters.playbookFileName }} with key ${{ parameters.privateKeyName }} and inventory ${{ parameters.inventoryFileName }}
