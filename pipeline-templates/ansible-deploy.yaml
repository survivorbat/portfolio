parameters:
  - name: ansibleDockerImage
    type: string
    default: 'survivorbat/ansible:v0.4'
  - name: rootDirectory
    type: string
  - name: playbookFileName
    type: string
    default: site.yaml
  - name: requirementsFileName
    type: string
    default: requirements.yaml
  - name: ansibleEnvironment
    type: object
    default: {}
  - name: inventoryFileName
    type: string
  # TODO: Change to key file
  - name: privateKey
    type: string

steps:
  - bash: |
      docker pull ${{ parameters.ansibleDockerImage }}
    displayName: Pull ${{ parameters.ansibleDockerImage }}

  - bash: |
      docker run --rm -v ${{ parameters.rootDirectory }}:/app ${{ parameters.ansibleDockerImage }} /bin/sh -c "\
        echo -e '${{ parameters.privateKey }}' > ~/.ssh/id_rsa
        ansible-galaxy install -r /app/${{ parameters.requirementsFileName }} && \
        ansible-playbook -i /app/${{ parameters.inventoryFileName }} /app/${{ parameters.playbookFileName }}"
    env:
      ANSIBLE_HOST_KEY_CHECKING: false
    displayName: Run ansible
